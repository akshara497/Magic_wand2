<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI Magic Wand</title>
    <script src="coi-serviceworker.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #121212; color: white; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; background: #1e1e1e; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #prediction { font-size: 3rem; font-weight: bold; color: #00ff88; margin: 20px 0; text-transform: uppercase; }
        #status { color: #888; margin-bottom: 20px; font-style: italic; }
        button { background: #007aff; color: white; border: none; padding: 20px 40px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; font-weight: bold; }
        button:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="project-name">Loading AI...</h2>
        <div id="status">Wait for "Ready"</div>
        <div id="prediction">---</div>
        <button id="btn-start">START WAND</button>
    </div>

    <script src="edge-impulse-standalone.js"></script>
    <script src="run-impulse.js"></script>

    <script>
        let classifier;
        let sensorData = [];
        const THRESHOLD = 0.75; // Only show result if AI is >75% sure

        (async () => {
            try {
                classifier = new EdgeImpulseClassifier();
                await classifier.init();
                let project = classifier.getProjectInfo();
                document.getElementById('project-name').textContent = project.name;
                document.getElementById('status').textContent = "Ready! Tap Start.";
            } catch (e) {
                document.getElementById('status').textContent = "Error: Model failed.";
            }
        })();

        document.getElementById('btn-start').onclick = async () => {
            // Force permission for iOS
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                const permission = await DeviceMotionEvent.requestPermission();
                if (permission !== 'granted') return alert("Sensors blocked!");
            }

            document.getElementById('btn-start').style.display = 'none';
            document.getElementById('status').textContent = "Wand Active - Move Phone!";

            window.addEventListener("devicemotion", (event) => {
                // Get accelerometer data
                const x = event.accelerationIncludingGravity.x;
                const y = event.accelerationIncludingGravity.y;
                const z = event.accelerationIncludingGravity.z;

                sensorData.push(x, y, z);

                // Most models use a 2-second window (approx 120 samples)
                if (sensorData.length >= 120) {
                    let res = classifier.classify(sensorData);
                    let top = res.results[0];

                    if (top.value > THRESHOLD) {
                        document.getElementById('prediction').textContent = top.label;
                    }

                    // Sliding window: keep most data but remove oldest 3 samples
                    sensorData.splice(0, 3);
                }
            });
        };
    </script>
</body>
</html>            let project = classifier.getProjectInfo();
            document.querySelector('h1').textContent = project.owner + ' / ' + project.name + ' (version ' + project.deploy_version + ')';

            document.querySelector('#run-inference').onclick = () => {
                try {
                    let features = document.querySelector('#features').value.split(',').map(x => Number(x.trim()));
                    let res = classifier.classify(features);
                    document.querySelector('#results').textContent = JSON.stringify(res, null, 4);
                }
                catch (ex) {
                    alert('Failed to classify: ' + (ex.message || ex.toString()));
                }
            };
        })();
    </script>
</body>
</html>
